<!DOCTYPE html>
<html>
	<head>
		<title>Pacman Map</title>
		<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	</head>
	<body>
		<div style="width:1600px;margin:auto">
			<!-- MAP SVG -->
		</div>
		<script>
		
			function CreateSvgElement(type,list,content = ""){
				var box = document.createElementNS("http://www.w3.org/2000/svg",type);
				$.each(list,function(index,element){
					box.setAttribute(index,element);
				});

				box.appendChild(document.createTextNode(content));
				return box;
			}
			
			var socket_tries = 0;
			
			function socket(adress){
				// Let us open a web socket
				ws = new WebSocket("ws://"+adress+"/");

				ws.onopen = function(){
				  //alert("Connected");
				  socket_tries = 0;
				};

				ws.onmessage = function (evt){
				  var received_msg = evt.data;
				  parseData(evt.data);
				};

				ws.onclose = function(event){
				  // websocket is closed.
				  console.log("Connection closed" + event.code);
				  if(socket_tries == 0){
					console.log("Connection Closed\nRetrying....");
				  }
				  if(socket_tries < 5){
					setTimeout(function(){
					  console.log("Reconnecting...");
					  socket(adress);
					  socket_tries++;
					}, 5000);
				  }else{
					console.log("No Connection posseble\nIs the server on?");
				  }
				};

			}
			
			function parseData(data){
				if(data == null){
					return
				}
				try{
				  json_data = JSON.parse(data);
				  
				  if(json_data['Food'] != undefined){
					  $.each($('svg .food'),function(element){
						  element.remove();
					  });
					  
					  $.each(json_data['Food'],function(index,element){
						  box = CreateSvgElement("rect",{"x":(element['x']),"y":(element['y']),"width":"10px","height":"10px","fill":"#00aa00","class":"food"});
						  $('svg').append(box);
					  });
				  }

				  if(json_data['Energizer'] != undefined){
					  $.each($('svg .energizer'),function(element){
						  element.remove();
					  });
					  
					  $.each(json_data['Energizer'],function(index,element){
						  box = CreateSvgElement("rect",{"x":(element['x']),"y":(element['y']),"width":"10px","height":"10px","fill":"#00FF00","class":"energizer"});
						  $('svg').append(box);
					  });
				  }

				  if(json_data['Cherry'] != undefined){
					  $.each($('svg .cherry'),function(element){
						  element.remove();
					  });
					  
					  $.each(json_data['Cherry'],function(index,element){
						  console.log("+Cherry");
						  console.log(json_data);
						  box = CreateSvgElement("rect",{"x":(element['x']),"y":(element['y']),"width":"10px","height":"10px","fill":"#FF44FF","class":"cherry"});
						  $('svg').append(box);
						  cherry_despawn(element['x'],element['y'],json_data['lifetime'])
					  });
				  }

				  if(json_data['Player'] != undefined){
					  $.each(json_data['Player'],function(index,element){
						  if($('svg #'+index).length == 0){
							  box = CreateSvgElement("rect",{"x":(element['x']),"y":(element['y']),"width":"10px","height":"10px","fill":"#FFFFFF","id":index});
							  $('svg').append(box);
						  }else{
							  $('svg #'+index).attr("x",(element['x']));
							  $('svg #'+index).attr("y",(element['y']));
							  if(element['type'] == "Unknown"){
								  $('svg #'+index).attr("fill","#FFFFFF");
							  }else if(element['type'] == "pacman"){
								  $('svg #'+index).attr("fill","#FFFF00");
							  }else if(element['type'] == "pacman.quarantine"){
								  $('svg #'+index).attr("fill","#FFFF77");
							  }else if(element['type'] == "pacman.energized"){
								  $('svg #'+index).attr("fill","#0000FF");
							  }else if(element['type'] == "ghost"){
								  $('svg #'+index).attr("fill","#FF0000");
							  }else if(element['type'] == "ghost.quarantine"){
								  $('svg #'+index).attr("fill","#FF7777");
							  }
						  }
					  });
				  }
			  }
			  catch(e){
				  console.log("Something throwed an Exception");
				  console.log(e);
			  }
			}
			
			function cherry_despawn(x,y,time){
				setTimeout(function(){
					console.log("Remove Cherry");
					$('svg .cherry[x='+(1600-(x/50))+'][y='+((y/50))+']')[0].remove();
				},time*1000)
			}
		
			function createY(x){
				var y = 0;
				while(true){
					if(((y/50))<10){
						break;
					}
					box = CreateSvgElement("rect",{"x":1600-(x/50),"y":(y/50),"width":"10px","height":"10px","stroke":"grey","style":"fill-opacity:0"});
					$('svg').append(box);
					y+= 500
				}
			}
		
			$(document).ready(function(){
				/*var x = 0;
				while(true){
					if((1600-(x/50))<10){
						break;
					}
					createY(x);
					console.log("X Row");
					x+= 500
				}*/
				
				if ("WebSocket" in window){
					setTimeout(socket(window.location.host+'/map'),5000);
				}
			});
		</script>
	</body>
</html>
